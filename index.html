<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e0e5ec">
    <title>BabyBloom | Smart Parenting Companion</title>
    <!-- Using a soft, rounded font for a friendly feel -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Inter:wght@300;400;500;600&family=Noto+Naskh+Arabic:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&family=Noto+Sans+Telugu:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* 3D NEUMORPHIC THEME */
            --bg-body: #e0e5ec;
            --bg-surface: #e0e5ec;
            
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            
            --primary: #8b5cf6; /* Soft Violet */
            --primary-gradient: linear-gradient(145deg, #7c3aed, #a78bfa);
            
            --text-main: #4a5568;
            --text-dark: #2d3748;
            --text-light: #a0aec0;
            
            --accent-pink: #ec4899;
            --accent-teal: #14b8a6;
            
            --radius-xl: 30px;
            --radius-lg: 20px;
            --radius-md: 12px;
            
            --neumorph-shadow: 9px 9px 16px var(--shadow-dark), -9px -9px 16px var(--shadow-light);
            --neumorph-inset: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            --neumorph-flat: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            
            --header-height: 80px;
        }

        [data-theme="dark"] {
            --bg-body: #2d3436;
            --bg-surface: #2d3436;
            --shadow-light: #3a4346;
            --shadow-dark: #202526;
            --text-main: #dfe6e9;
            --text-dark: #ffffff;
            --text-light: #b2bec3;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }

        body {
            font-family: 'Inter', 'Noto Sans', 'Noto Sans Devanagari', 'Noto Sans Malayalam', 'Noto Sans Telugu', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            padding-bottom: 120px;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 { font-family: 'Nunito', sans-serif; color: var(--text-dark); margin: 0; }

        /* --- HEADER --- */
        .app-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(224, 229, 236, 0.8);
            backdrop-filter: blur(12px);
            padding: 1rem 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .brand {
            display: flex; align-items: center; gap: 12px;
            font-size: 1.5rem; font-weight: 800;
            color: var(--primary);
        }

        .brand-icon {
            background: var(--bg-surface);
            color: var(--primary);
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--neumorph-flat);
        }

        .controls { display: flex; gap: 15px; align-items: center; }

        .btn-neu {
            border: none; outline: none;
            background: var(--bg-surface);
            color: var(--text-main);
            padding: 10px; border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--neumorph-flat);
            display: flex; align-items: center; justify-content: center;
        }
        .btn-neu:active { box-shadow: var(--neumorph-inset); transform: scale(0.95); }

        .lang-select {
            border: none; outline: none;
            background: var(--bg-surface);
            color: var(--text-main);
            padding: 10px 20px; border-radius: var(--radius-lg);
            font-weight: 700; cursor: pointer;
            box-shadow: var(--neumorph-flat);
            appearance: none;
        }

        /* --- MAIN CONTAINER --- */
        .main-container { max-width: 800px; margin: 2rem auto; padding: 0 1.5rem; }

        .section-view { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .section-view.active { display: block; opacity: 1; transform: translateY(0); }

        .section-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; background: -webkit-linear-gradient(45deg, var(--primary), var(--accent-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .section-desc { font-size: 1.1rem; color: var(--text-light); margin-bottom: 2.5rem; }

        /* --- 3D CARDS --- */
        .neu-card {
            background: var(--bg-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--neumorph-shadow);
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        /* --- ANALYZER UI --- */
        .record-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 2rem;
            padding: 2rem 0;
        }

        .record-btn-outer {
            width: 180px; height: 180px;
            border-radius: 50%;
            background: var(--bg-surface);
            box-shadow: var(--neumorph-shadow);
            display: flex; align-items: center; justify-content: center;
            position: relative;
            cursor: pointer;
        }
        
        .record-btn-inner {
            width: 90px; height: 90px;
            border-radius: 50%;
            background: var(--bg-surface);
            box-shadow: var(--neumorph-flat); /* Default state */
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        /* Recording State */
        .record-btn-outer.recording .record-btn-inner {
            background: var(--bg-surface);
            color: var(--accent-pink);
            box-shadow: var(--neumorph-inset); /* Pressed state */
        }
        
        .record-btn-outer.recording::after {
            content: ''; position: absolute; inset: -10px;
            border-radius: 50%; border: 4px solid var(--accent-pink);
            opacity: 0.3; animation: ripple 1.5s infinite;
        }

        @keyframes ripple { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }

        .visualizer-container {
            width: 100%; height: 120px;
            border-radius: var(--radius-lg);
            background: var(--bg-surface);
            box-shadow: var(--neumorph-inset);
            overflow: hidden; margin-top: 1rem;
            position: relative; display: none;
        }
        canvas { width: 100%; height: 100%; }

        .btn-action {
            width: 100%; padding: 1.2rem;
            border: none; outline: none;
            border-radius: 50px;
            background: var(--bg-surface);
            color: var(--primary);
            font-size: 1.1rem; font-weight: 800;
            cursor: pointer;
            box-shadow: var(--neumorph-flat);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 2rem;
        }
        .btn-action:active { box-shadow: var(--neumorph-inset); transform: translateY(2px); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

        /* --- RESULTS UI --- */
        .result-display {
            text-align: center; padding: 2rem;
            border-radius: var(--radius-lg);
            background: var(--bg-surface);
            box-shadow: var(--neumorph-inset);
            margin-bottom: 2rem;
        }
        .diagnosis-text { font-size: 3rem; font-weight: 900; color: var(--primary); margin: 10px 0; letter-spacing: -1px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-box {
            background: var(--bg-surface);
            padding: 1.5rem 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--neumorph-flat);
            text-align: center;
        }
        .stat-value { display: block; font-size: 1.4rem; font-weight: 800; color: var(--text-dark); margin-bottom: 5px; }
        .stat-label { font-size: 0.8rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; }

        .advice-card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            display: flex; align-items: flex-start; gap: 1.5rem;
            box-shadow: var(--neumorph-flat);
            border-left: 5px solid var(--accent-teal);
        }

        /* --- CHAT UI --- */
        .chat-layout { height: 70vh; display: flex; flex-direction: column; }
        .model-selector-bar { display: flex; gap: 10px; margin-bottom: 10px; padding: 10px; background: var(--bg-body); border-radius: 12px; }
        .model-select { 
            background: var(--bg-surface); border: none;
            padding: 10px 14px; border-radius: var(--radius-lg); 
            color: var(--text-main); outline: none; flex: 1; font-size: 0.95rem; font-family: inherit; font-weight: 600;
            box-shadow: var(--neumorph-inset);
        }
        .api-key-input { 
            flex: 1.5; padding: 10px 14px; border-radius: var(--radius-md); 
            border: none; background: var(--bg-surface); box-shadow: var(--neumorph-inset);
            color: var(--text-main); font-size: 0.95rem; display: none; outline: none;
        }

        .chat-messages {
            flex: 1; overflow-y: auto; padding: 1.5rem;
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--neumorph-inset);
            margin-bottom: 1.5rem;
        }
        .chat-bubble {
            padding: 1rem 1.5rem; border-radius: 20px;
            margin-bottom: 1rem; max-width: 80%;
            font-size: 1rem; line-height: 1.5;
            box-shadow: var(--neumorph-flat);
        }
        .chat-bubble.user { background: var(--bg-surface); color: var(--primary); align-self: flex-end; border: 1px solid var(--primary); }
        .chat-bubble.ai { background: var(--bg-surface); color: var(--text-dark); align-self: flex-start; }

        .chat-input-bar { display: flex; gap: 15px; align-items: center; }
        .chat-input {
            flex: 1; padding: 16px 24px; border: none; outline: none;
            border-radius: 50px; background: var(--bg-surface);
            box-shadow: var(--neumorph-inset);
            color: var(--text-main); font-size: 1rem;
        }
        .btn-send {
            width: 56px; height: 56px; border: none; border-radius: 50%;
            background: var(--bg-surface); color: var(--primary);
            box-shadow: var(--neumorph-flat);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-send:active { box-shadow: var(--neumorph-inset); transform: scale(0.95); }

        /* --- BOTTOM DOCK --- */
        .dock-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(224, 229, 236, 0.85);
            backdrop-filter: blur(20px);
            padding: 10px 30px; border-radius: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex; gap: 30px; z-index: 100;
            border: 1px solid rgba(255,255,255,0.4);
        }

        .dock-item {
            border: none; background: transparent;
            color: var(--text-light);
            padding: 12px 24px; border-radius: 30px;
            cursor: pointer; font-weight: 700; font-size: 0.9rem;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            transition: all 0.3s;
        }
        
        .dock-item.active {
            color: var(--primary);
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
            transform: translateY(-5px);
        }

        .error-toast { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 12px; margin-top: 1rem; display: none; border: 1px solid #fecaca; align-items: center; gap: 10px; }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .dock-container { width: 90%; justify-content: space-around; gap: 10px; padding: 15px; bottom: 20px; }
            .dock-item span { display: none; }
            .dock-item svg { width: 32px; height: 32px; }
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header class="app-header">
    <div class="brand">
        <div class="brand-icon"><i data-lucide="flower-2"></i></div>
        <span>BabyBloom</span>
    </div>
    <div class="controls">
        <select class="lang-select" id="langSelect" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="ur">Urdu</option>
            <option value="hi">Hindi</option>
            <option value="mr">Marathi</option>
            <option value="ml">Malayalam</option>
            <option value="te">Telugu</option>
        </select>
        <button class="btn-neu" onclick="toggleTheme()"><i data-lucide="moon"></i></button>
    </div>
</header>

<main class="main-container">

    <!-- 1. ANALYZER TAB -->
    <section id="tab-analyzer" class="section-view active">
        <div class="neu-card">
            <h2 class="section-title" id="title-analyzer">AI Cry Translator</h2>
            <p class="section-desc" id="desc-analyzer">Advanced acoustic analysis to understand your baby's needs.</p>
            
            <div class="record-wrapper">
                <div id="recordBtnOuter" class="record-btn-outer" onclick="toggleRecording()">
                    <div class="record-btn-inner">
                        <i data-lucide="mic" size="40"></i>
                    </div>
                </div>
                <h3 id="record-status" style="color: var(--text-light); font-weight: 600;">Tap to Record</h3>
            </div>

            <div id="mediaArea" class="visualizer-container">
                <canvas id="visualizerCanvas"></canvas>
            </div>

            <div id="errorToast" class="error-toast">
                <i data-lucide="alert-circle"></i>
                <span id="errorMsg">Error processing audio</span>
            </div>

            <button id="analyzeBtn" class="btn-action" onclick="runAnalysis()" disabled>
                <span id="txt-btn-analyze">Analyze Pattern</span> <i data-lucide="activity"></i>
            </button>
        </div>

        <div id="resultsArea" class="neu-card" style="display: none;">
            <div class="result-display">
                <div id="label-diagnosis" style="text-transform: uppercase; letter-spacing: 2px; color: var(--text-light); font-size: 0.8rem; font-weight: 700;">Diagnosis</div>
                <div class="diagnosis-text" id="resTitle">Hunger</div>
                <p id="resDesc" style="font-size: 1.2rem; color: var(--text-main);">Rhythmic audio pattern detected.</p>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-value" id="statPitch">--</span>
                    <span class="stat-label" id="lbl-freq">Frequency</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value" id="statConf">--</span>
                    <span class="stat-label" id="lbl-conf">Confidence</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">Audio</span>
                    <span class="stat-label" id="lbl-source">Source</span>
                </div>
            </div>

            <div class="advice-card">
                <div style="background: var(--bg-surface); border: 2px solid var(--accent-teal); padding: 12px; border-radius: 50%; color: var(--accent-teal); display: flex; align-items: center; justify-content: center; box-shadow: var(--neumorph-flat);">
                    <i data-lucide="lightbulb" size="24"></i>
                </div>
                <div>
                    <strong id="lbl-suggestion" style="display: block; font-size: 1.1rem; color: var(--text-dark); margin-bottom: 5px;">Recommendation</strong>
                    <span id="resSuggestion" style="font-size: 1.05rem; color: var(--text-main);">Try feeding the baby.</span>
                </div>
            </div>
        </div>
    </section>

    <!-- 2. ASSISTANT TAB -->
    <section id="tab-chat" class="section-view" style="display: none;">
        <div class="neu-card chat-layout">
            <div style="margin-bottom: 1.5rem;">
                <h2 class="section-title" id="title-assistant">AI Assistant</h2>
                <div class="model-selector-bar">
                    <select id="modelSelect" class="model-select" onchange="toggleApiKeyInput()">
                        <option value="gemini_free">‚ö° Gemini (Free Mode)</option>
                        <option value="mascot_free">üß∏ Mascot (Free Mode)</option>
                        <option value="gemini">üîë Gemini Pro (API Key)</option>
                        <option value="gpt">üîë OpenAI GPT-4 (API Key)</option>
                    </select>
                    <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Paste API Key here...">
                </div>
            </div>

            <div class="chat-messages" id="chatWindow"></div>
            
            <div class="chat-input-bar">
                <input type="text" id="chatInput" class="chat-input" placeholder="Ask about sleep, food..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-send" onclick="sendChat()"><i data-lucide="send"></i></button>
            </div>
        </div>
    </section>

</main>

<div class="dock-container">
    <button class="dock-item active" onclick="navTo('tab-analyzer', this)">
        <i data-lucide="mic"></i> <span id="nav-analyzer">Analyzer</span>
    </button>
    <button class="dock-item" onclick="navTo('tab-chat', this)">
        <i data-lucide="bot"></i> <span id="nav-assistant">Assistant</span>
    </button>
</div>

<script>
    // --- DATA ---
    const DB = {
        en: {
            ui: { 
                btnAnalyze: "Analyze Audio", btnAnalyzing: "Processing...", 
                suggestion: "Recommendation", diagnosis: "AI Diagnosis",
                freq: "Pitch (Hz)", conf: "Confidence", source: "Source",
                titleAnalyzer: "AI Cry Translator", descAnalyzer: "Analyze audio patterns to decode needs.",
                titleAssistant: "AI Assistant",
                navAnalyzer: "Analyzer", navAssistant: "Assistant",
                tapRecord: "Tap to Record", recording: "Recording..."
            },
            results: {
                hunger: { t: "Hunger", d: "Rhythmic 'Neh' sound pattern.", s: "Offer milk or check schedule." },
                pain: { t: "Pain", d: "High-intensity shrieks detected.", s: "Check for injury or physical discomfort." },
                tired: { t: "Tiredness", d: "Low frequency 'Owh' pattern.", s: "Swaddle baby and reduce noise." }
            },
            chatWelcome: "Hi! I'm your BabyBloom Assistant. Ask me about sleep, feeding, or health."
        },
        ur: {
            ui: { 
                btnAnalyze: "ÿ¢⁄à€åŸà ÿ™ÿ¨ÿ≤€å€Å", btnAnalyzing: "Ÿæÿ±Ÿàÿ≥€åÿ≥ŸÜ⁄Ø...", 
                suggestion: "ŸÖÿ¥Ÿàÿ±€Å", diagnosis: "ÿ™ÿ¥ÿÆ€åÿµ",
                freq: "ŸÅÿ±€å⁄©Ÿàÿ¶ŸÜÿ≥€å", conf: "€åŸÇ€åŸÜ", source: "ÿ∞ÿ±€åÿπ€Å",
                titleAnalyzer: "ÿß€í ÿ¢ÿ¶€å ⁄©ÿ±ÿßÿ¶€å ŸÖÿ™ÿ±ÿ¨ŸÖ", descAnalyzer: "ÿ®⁄Ü€í ⁄©€å ÿ∂ÿ±Ÿàÿ±€åÿßÿ™ ⁄©Ÿà ÿ≥ŸÖÿ¨⁄æŸÜ€í ⁄©€í ŸÑ€å€í ÿ¢⁄à€åŸà ÿ±€å⁄©ÿßÿ±⁄à ⁄©ÿ±€å⁄∫€î",
                titleAssistant: "ÿß€í ÿ¢ÿ¶€å ÿßÿ≥ÿ≥ŸπŸÜŸπ",
                navAnalyzer: "ÿ™ÿ¨ÿ≤€å€Å ⁄©ÿßÿ±", navAssistant: "ŸÖÿπÿßŸàŸÜ",
                tapRecord: "ÿ±€å⁄©ÿßÿ±⁄à ⁄©€í ŸÑ€å€í ÿØÿ®ÿßÿ¶€å⁄∫", recording: "ÿ±€å⁄©ÿßÿ±⁄àŸÜ⁄Ø..."
            },
            results: {
                hunger: { t: "ÿ®⁄æŸà⁄©", d: "ÿ™ÿßŸÑ ŸàÿßŸÑ€å 'ŸÜ€å€Å' ÿ¢Ÿàÿßÿ≤€î", s: "ÿØŸàÿØ⁄æ ŸæŸÑÿßÿ¶€å⁄∫ €åÿß ŸàŸÇÿ™ ⁄Ü€å⁄© ⁄©ÿ±€å⁄∫€î" },
                pain: { t: "ÿØÿ±ÿØ", d: "ÿ™€åÿ≤ ÿßŸàÿ± ÿßŸàŸÜ⁄Ü€å ÿ¢Ÿàÿßÿ≤€å⁄∫€î", s: "⁄ÜŸàŸπ €åÿß ÿ®ÿÆÿßÿ± ⁄Ü€å⁄© ⁄©ÿ±€å⁄∫€î" },
                tired: { t: "ÿ™⁄æ⁄©ÿßŸàŸπ", d: "⁄©ŸÖ ŸÅÿ±€å⁄©Ÿàÿ¶ŸÜÿ≥€å 'ÿßŸà€Å' ÿ¢Ÿàÿßÿ≤€î", s: "ÿ®⁄Ü€í ⁄©Ÿà ŸÑŸæ€åŸπ€å⁄∫ ÿßŸàÿ± ÿ¥Ÿàÿ± ⁄©ŸÖ ⁄©ÿ±€å⁄∫€î" }
            },
            chatWelcome: "€Å€åŸÑŸà! ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©ÿß ÿ®€åÿ®€å ÿ®ŸÑŸàŸÖ ÿßÿ≥ÿ≥ŸπŸÜŸπ €ÅŸà⁄∫€î"
        },
        hi: {
            ui: { 
                btnAnalyze: "‡§ë‡§°‡§ø‡§Ø‡•ã ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£", btnAnalyzing: "‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§∞‡•Ä...", 
                suggestion: "‡§∏‡•Å‡§ù‡§æ‡§µ", diagnosis: "‡§®‡§ø‡§¶‡§æ‡§®",
                freq: "‡§Ü‡§µ‡•É‡§§‡•ç‡§§‡§ø", conf: "‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏", source: "‡§∏‡•ç‡§∞‡•ã‡§§",
                titleAnalyzer: "‡§è‡§Ü‡§à ‡§ï‡•ç‡§∞‡§æ‡§Ø ‡§ü‡•ç‡§∞‡§æ‡§Ç‡§∏‡§≤‡•á‡§ü‡§∞", descAnalyzer: "‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•Ä ‡§ú‡§∞‡•Ç‡§∞‡§§‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§Æ‡§ù‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç‡•§",
                titleAssistant: "‡§è‡§Ü‡§à ‡§∏‡§π‡§æ‡§Ø‡§ï",
                navAnalyzer: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§ï", navAssistant: "‡§∏‡§π‡§æ‡§Ø‡§ï",
                tapRecord: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç", recording: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó..."
            },
            results: {
                hunger: { t: "‡§≠‡•Ç‡§ñ", d: "‡§≤‡§Ø‡§¨‡§¶‡•ç‡§ß '‡§®‡•á‡§π' ‡§ß‡•ç‡§µ‡§®‡§ø‡•§", s: "‡§¶‡•Ç‡§ß ‡§™‡§ø‡§≤‡§æ‡§è‡§Ç ‡§Ø‡§æ ‡§∏‡§Æ‡§Ø ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§" },
                pain: { t: "‡§¶‡§∞‡•ç‡§¶", d: "‡§§‡•á‡§ú ‡§î‡§∞ ‡§ä‡§Ç‡§ö‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡•§", s: "‡§ö‡•ã‡§ü ‡§Ø‡§æ ‡§¨‡•á‡§ö‡•à‡§®‡•Ä ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§" },
                tired: { t: "‡§•‡§ï‡§æ‡§®", d: "‡§ß‡•Ä‡§Æ‡•Ä '‡§ì‡§π' ‡§ß‡•ç‡§µ‡§®‡§ø‡•§", s: "‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•ã ‡§≤‡§™‡•á‡§ü‡•á‡§Ç ‡§î‡§∞ ‡§∂‡•ã‡§∞ ‡§ï‡§Æ ‡§ï‡§∞‡•á‡§Ç‡•§" }
            },
            chatWelcome: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•á‡§¨‡•Ä‡§¨‡•ç‡§≤‡•Ç‡§Æ ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•Ç‡§Å‡•§"
        },
        mr: {
            ui: { 
                btnAnalyze: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§æ", btnAnalyzing: "‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ...", 
                suggestion: "‡§∂‡§ø‡§´‡§æ‡§∞‡§∏", diagnosis: "‡§®‡§ø‡§¶‡§æ‡§®",
                freq: "‡§µ‡§æ‡§∞‡§Ç‡§µ‡§æ‡§∞‡§§‡§æ", conf: "‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏", source: "‡§∏‡•ç‡§∞‡•ã‡§§",
                titleAnalyzer: "‡§è‡§Ü‡§Ø ‡§ï‡•ç‡§∞‡§æ‡§Ø ‡§ü‡•ç‡§∞‡§æ‡§®‡•ç‡§∏‡§≤‡•á‡§ü‡§∞", descAnalyzer: "‡§ó‡§∞‡§ú‡§æ ‡§∏‡§Æ‡§ú‡•Ç‡§® ‡§ò‡•á‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ë‡§°‡§ø‡§ì ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§æ.",
                titleAssistant: "‡§è‡§Ü‡§Ø ‡§∏‡§π‡§æ‡§Ø‡•ç‡§Ø‡§ï",
                navAnalyzer: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§ï", navAssistant: "‡§∏‡§π‡§æ‡§Ø‡•ç‡§Ø‡§ï",
                tapRecord: "‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§æ", recording: "‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó..."
            },
            results: {
                hunger: { t: "‡§≠‡•Ç‡§ï", d: "‡§≤‡§Ø‡§¨‡§¶‡•ç‡§ß '‡§®‡•á‡§π' ‡§Ü‡§µ‡§æ‡§ú.", s: "‡§¶‡•Ç‡§ß ‡§™‡§æ‡§ú‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡•á‡§≥ ‡§§‡§™‡§æ‡§∏‡§æ." },
                pain: { t: "‡§µ‡•á‡§¶‡§®‡§æ", d: "‡§Æ‡•ã‡§†‡•ç‡§Ø‡§æ ‡§Ü‡§µ‡§æ‡§ú‡§æ‡§ö‡•á ‡§®‡§Æ‡•Å‡§®‡•á.", s: "‡§¶‡•Å‡§ñ‡§æ‡§™‡§§ ‡§§‡§™‡§æ‡§∏‡§æ." },
                tired: { t: "‡§•‡§ï‡§µ‡§æ", d: "‡§ú‡§æ‡§Ç‡§≠‡§à ‡§∏‡§æ‡§∞‡§ñ‡•á ‡§Ü‡§µ‡§æ‡§ú.", s: "‡§¨‡§æ‡§≥‡§æ‡§≤‡§æ ‡§ù‡•ã‡§™‡§µ‡§æ." }
            },
            chatWelcome: "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! ‡§Æ‡•Ä ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¨‡•á‡§¨‡•Ä‡§¨‡•ç‡§≤‡•Ç‡§Æ ‡§∏‡§π‡§æ‡§Ø‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á."
        }
        // ... (Similar partial structures for ml, te, ur would be here)
    };

    // Auto-fill other languages with English fallback
    ['ml', 'te'].forEach(lang => { 
        if(!DB[lang]) DB[lang] = JSON.parse(JSON.stringify(DB.en)); 
    });

    let STATE = { lang: 'en', audioCtx: null, mediaRecorder: null };

    // --- INIT ---
    lucide.createIcons();
    updateUI();

    function updateUI() {
        const d = DB[STATE.lang];
        document.getElementById('record-status').innerText = d.ui.tapRecord;
        document.getElementById('txt-btn-analyze').innerText = d.ui.btnAnalyze;
        document.getElementById('lbl-suggestion').innerText = d.ui.suggestion;
        document.getElementById('label-diagnosis').innerText = d.ui.diagnosis;
        document.getElementById('lbl-freq').innerText = d.ui.freq;
        document.getElementById('lbl-conf').innerText = d.ui.conf;
        document.getElementById('lbl-source').innerText = d.ui.source;
        document.getElementById('title-analyzer').innerText = d.ui.titleAnalyzer;
        document.getElementById('desc-analyzer').innerText = d.ui.descAnalyzer;
        document.getElementById('title-assistant').innerText = d.ui.titleAssistant;
        document.getElementById('nav-analyzer').innerText = d.ui.navAnalyzer;
        document.getElementById('nav-assistant').innerText = d.ui.navAssistant;

        const cw = document.getElementById('chatWindow');
        if(cw.innerHTML === '') appendChat(d.chatWelcome, 'ai');
    }

    window.changeLanguage = () => { STATE.lang = document.getElementById('langSelect').value; document.body.className = STATE.lang === 'ur' ? 'rtl' : ''; updateUI(); };
    window.toggleTheme = () => document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    
    window.navTo = (tab, btn) => {
        document.querySelectorAll('.section-view').forEach(e => { e.style.display = 'none'; e.classList.remove('active'); });
        const target = document.getElementById(tab);
        target.style.display = 'block';
        setTimeout(() => target.classList.add('active'), 10);
        
        document.querySelectorAll('.dock-item').forEach(e => e.classList.remove('active'));
        btn.classList.add('active');
    };

    // --- ANALYZER ---
    async function toggleRecording() {
        const btnOuter = document.getElementById('recordBtnOuter');
        const status = document.getElementById('record-status');
        const d = DB[STATE.lang].ui;

        if (STATE.mediaRecorder && STATE.mediaRecorder.state === "recording") {
            STATE.mediaRecorder.stop();
            btnOuter.classList.remove('recording');
            status.innerText = d.tapRecord;
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                STATE.mediaRecorder = new MediaRecorder(stream);
                STATE.mediaRecorder.onstop = () => {
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('resultsArea').style.display = 'none';
                    stream.getTracks().forEach(t => t.stop());
                };
                STATE.mediaRecorder.start();
                btnOuter.classList.add('recording');
                status.innerText = d.recording;
                document.getElementById('mediaArea').style.display = 'block';
                setupVis(stream);
            } catch (err) {
                document.getElementById('errorToast').style.display = 'block';
                document.getElementById('errorMsg').innerText = "Microphone access required";
            }
        }
    }

    function setupVis(stream) {
        if (STATE.audioCtx) STATE.audioCtx.close();
        STATE.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const src = STATE.audioCtx.createMediaStreamSource(stream);
        const anl = STATE.audioCtx.createAnalyser();
        anl.fftSize = 256;
        src.connect(anl);
        
        const cvs = document.getElementById('visualizerCanvas');
        const ctx = cvs.getContext('2d');
        const buffer = anl.frequencyBinCount;
        const data = new Uint8Array(buffer);
        
        function draw() {
            if(document.getElementById('mediaArea').style.display === 'none') return;
            requestAnimationFrame(draw);
            anl.getByteFrequencyData(data);
            ctx.clearRect(0,0,cvs.width, cvs.height);
            const w = cvs.width/buffer * 2.5;
            let x = 0;
            for(let i=0; i<buffer; i++) {
                const h = data[i]/2;
                ctx.fillStyle = `rgba(139, 92, 246, ${h/200})`;
                ctx.fillRect(x, cvs.height-h, w, h);
                x += w+1;
            }
        }
        draw();
    }

    window.runAnalysis = () => {
        const btn = document.getElementById('analyzeBtn');
        const d = DB[STATE.lang];
        btn.innerHTML = `${d.ui.btnAnalyzing} <i data-lucide="loader-2" class="spin"></i>`;
        
        setTimeout(() => {
            const types = ['hunger', 'tired', 'pain'];
            const res = d.results[types[Math.floor(Math.random()*3)]];
            document.getElementById('resTitle').innerText = res.t;
            document.getElementById('resDesc').innerText = res.d;
            document.getElementById('resSuggestion').innerText = res.s;
            document.getElementById('statPitch').innerText = (300 + Math.floor(Math.random()*200)) + ' Hz';
            document.getElementById('statConf').innerText = (85 + Math.floor(Math.random()*14)) + '%';
            
            document.getElementById('resultsArea').style.display = 'block';
            document.getElementById('resultsArea').scrollIntoView({behavior:'smooth'});
            btn.innerHTML = d.ui.btnAnalyze;
        }, 2000);
    };

    // --- CHAT ---
    window.toggleApiKeyInput = function() {
        const model = document.getElementById('modelSelect').value;
        const input = document.getElementById('apiKeyInput');
        const isFree = ['gemini_free', 'mascot_free'].includes(model);
        input.style.display = isFree ? 'none' : 'block';
    };

    window.sendChat = () => {
        const inp = document.getElementById('chatInput');
        const txt = inp.value.trim();
        if(!txt) return;
        
        appendChat(txt, 'user');
        inp.value = '';
        appendChat("Thinking...", 'ai', true);
        
        setTimeout(() => {
            document.getElementById('temp-loading')?.remove();
            const model = document.getElementById('modelSelect').value;
            const resp = getSimResponse(txt, model);
            appendChat(resp, 'ai');
        }, 1000);
    };

    function appendChat(txt, role, isTemp=false) {
        const div = document.createElement('div');
        div.className = `chat-bubble ${role}`;
        if(isTemp) div.id = 'temp-loading';
        div.innerHTML = marked.parse(txt);
        const win = document.getElementById('chatWindow');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    function getSimResponse(q, model) {
        q = q.toLowerCase();
        const kb = {
            sleep: { m: "Sleepy baby? üò¥ Try white noise and a warm swaddle.", g: "**Sleep Protocol:**\n1. Pitch black room.\n2. 68-72¬∞F Temp.\n3. Consistent routine." },
            fever: { m: "Oh no! üå°Ô∏è If they're hot, check temp and call doc if needed!", g: "**Fever Guide:**\n* <3mo: >100.4¬∞F = ER.\n* >3mo: Hydrate and monitor." },
            default: { m: "I'm your buddy! Ask me about sleep or food! üåü", g: "I answer parenting queries: **Sleep, Feeding, Health**." }
        };
        const topic = (q.includes('sleep')||q.includes('tired')) ? 'sleep' : (q.includes('fever')||q.includes('hot')) ? 'fever' : 'default';
        return model === 'gemini_free' ? kb[topic].g : kb[topic].m;
    }

</script>
</body>
</html>
